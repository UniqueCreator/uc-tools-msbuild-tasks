<?xml version="1.0" encoding="utf-8"?>

<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

    <UsingTask AssemblyFile="$(UCToolsBuildTasks)" TaskName="UniqueCreator.Build.Tasks.GraphicsPipelineStateObject"/>
    <UsingTask AssemblyFile="$(UCToolsBuildTasks)" TaskName="UniqueCreator.Build.Tasks.ComputePipelineStateObject"/>
    <UsingTask AssemblyFile="$(UCToolsBuildTasks)" TaskName="UniqueCreator.Build.Tasks.FXCompilerPixel"/>
    <UsingTask AssemblyFile="$(UCToolsBuildTasks)" TaskName="UniqueCreator.Build.Tasks.FXCompilerVertex"/>
    <UsingTask AssemblyFile="$(UCToolsBuildTasks)" TaskName="UniqueCreator.Build.Tasks.FXCompilerCompute"/>
    <UsingTask AssemblyFile="$(UCToolsBuildTasks)" TaskName="UniqueCreator.Build.Tasks.FXCompilerDomain"/>
    <UsingTask AssemblyFile="$(UCToolsBuildTasks)" TaskName="UniqueCreator.Build.Tasks.FXCompilerHull"/>
	<UsingTask AssemblyFile="$(UCToolsBuildTasks)" TaskName="UniqueCreator.Build.Tasks.FXCompilerGeometry"/>
	<UsingTask AssemblyFile="$(UCToolsBuildTasks)" TaskName="UniqueCreator.Build.Tasks.FXCompilerRootSignature"/>

    <PropertyGroup>
        <AutoGeneratedGraphicsPipelineStateObjects Condition="$(AutoGeneratedGraphicsPipelineStateObjects) == ''">$(MSBuildThisFileDirectory)autogen\$(Platform)\$(ProjectName)shaders\</AutoGeneratedGraphicsPipelineStateObjects>
        <AutoGeneratedComputePipelineStateObjects Condition="$(AutoGeneratedGraphicsPipelineStateObjects) == ''">$(MSBuildThisFileDirectory)autogen\$(Platform)\$(ProjectName)shaders\</AutoGeneratedComputePipelineStateObjects>
        <AutoGeneratedPixelShaders Condition="$(AutoGeneratedPixelShaders) == ''">$(MSBuildThisFileDirectory)autogen\$(Platform)\$(ProjectName)shaders\</AutoGeneratedPixelShaders>
    </PropertyGroup>

    <ItemDefinitionGroup>
        <GraphicsPipelineStateObject>
            <EntryPointName>main</EntryPointName>
        </GraphicsPipelineStateObject>
    </ItemDefinitionGroup>

    <ItemDefinitionGroup>
        <ComputePipelineStateObject>
            <EntryPointName>main</EntryPointName>
        </ComputePipelineStateObject>
    </ItemDefinitionGroup>

    <ItemDefinitionGroup>
        <PixelShader>
            <EntryPointName>main</EntryPointName>
            <PreprocessorDefinitions></PreprocessorDefinitions>
        </PixelShader>
    </ItemDefinitionGroup>

    <Target Name="UcToolsGenerateGraphicsItems" Condition="'@(GraphicsPipelineStateObject)' != ''">
        <CreateItem Include = "@(GraphicsPipelineStateObject)" PreserveExistingMetadata="True" AdditionalMetadata="CPPHeaderOutput=$(AutoGeneratedGraphicsPipelineStateObjects)%(GraphicsPipelineStateObject.EntryPointName).h;CPPOutput=$(AutoGeneratedGraphicsPipelineStateObjects)%(GraphicsPipelineStateObject.EntryPointName).cpp">
            <Output TaskParameter ="Include" ItemName = "GraphicsPipelineStateObjectBuilds"/>
        </CreateItem>
    </Target>   

     <Target Name="UcToolsGenerateComputeItems" Condition="'@(ComputePipelineStateObject)' != ''">
        <CreateItem Include = "@(ComputePipelineStateObject)" PreserveExistingMetadata="True" AdditionalMetadata="CPPHeaderOutput=$(AutoGeneratedComputePipelineStateObjects)%(ComputePipelineStateObject.EntryPointName).h;CPPOutput=$(AutoGeneratedComputePipelineStateObjects)%(ComputePipelineStateObject.EntryPointName).cpp">
            <Output TaskParameter ="Include" ItemName = "ComputePipelineStateObjectBuilds"/>
        </CreateItem>
    </Target>       

    <Target Name="UcToolsGeneratePixelShaderItems" Condition="'@(PixelShader)' != ''">
        <CreateItem Include = "@(PixelShader)" PreserveExistingMetadata="True" AdditionalMetadata="CPPHeaderOutput=$(AutoGeneratedPixelShaders)%(PixelShader.FileName).h;CPPOutput=$(AutoGeneratedPixelShaders)%(PixelShader.FileName).cpp;TypeName=%(PixelShader.FileName)">
            <Output TaskParameter ="Include" ItemName = "PixelShaderBuilds"/>
        </CreateItem>
    </Target>   

    <Target Name="UcToolsMakeDirsGraphics" DependsOnTargets="UcToolsGenerateGraphicsItems" Condition="'@(GraphicsPipelineStateObject)' != ''">

        <ItemGroup Condition="'@(GraphicsPipelineStateObject)'!=''">
          <Outputs Include="@(GraphicsPipelineStateObjectBuilds->Metadata('CPPHeaderOutput')->Distinct())" />
          <Outputs Include="@(GraphicsPipelineStateObjectBuilds->Metadata('CPPOutput')->Distinct())" />
          <DirsToMake Include="@(Outputs->DirectoryName())" />
        </ItemGroup>

        <MakeDir Directories="@(DirsToMake)" />

        <ItemGroup>
            <DirsToMake Remove="@(DirsToMake)" />
        </ItemGroup>
    </Target>

     <Target Name="UcToolsMakeDirsCompute" DependsOnTargets="UcToolsGenerateComputeItems" Condition="'@(ComputePipelineStateObject)' != ''">

        <ItemGroup Condition="'@(ComputePipelineStateObject)'!=''">
          <Outputs Include="@(ComputePipelineStateObjectBuilds->Metadata('CPPHeaderOutput')->Distinct())" />
          <Outputs Include="@(ComputePipelineStateObjectBuilds->Metadata('CPPOutput')->Distinct())" />
          <DirsToMake Include="@(Outputs->DirectoryName())" />
        </ItemGroup>

        <MakeDir Directories="@(DirsToMake)" />

        <ItemGroup>
            <DirsToMake Remove="@(DirsToMake)" />
        </ItemGroup>
    </Target>

    <Target Name="UcToolsMakeDirsPixelShader" DependsOnTargets="UcToolsGeneratePixelShaderItems" Condition="'@(PixelShader)' != ''">

        <ItemGroup Condition="'@(PixelShader)'!=''">
          <Outputs Include="@(PixelShaderBuilds->Metadata('CPPHeaderOutput')->Distinct())" />
          <Outputs Include="@(PixelShaderBuilds->Metadata('CPPOutput')->Distinct())" />
          <DirsToMake Include="@(Outputs->DirectoryName())" />
        </ItemGroup>

        <MakeDir Directories="@(DirsToMake)" />

        <ItemGroup>
            <DirsToMake Remove="@(DirsToMake)" />
        </ItemGroup>
    </Target>

    <Target Name="UcToolsGenerateGraphics" DependsOnTargets="UcToolsMakeDirsGraphics;UcToolsGenerateGraphicsItems" Condition="'@(GraphicsPipelineStateObject)' != ''">
        <GraphicsPipelineStateObject 
            Source                      ="%(GraphicsPipelineStateObjectBuilds.FullPath)" EntryPointName ="%(GraphicsPipelineStateObjectBuilds.EntryPointName)"
            CPPOutput                   ="%(GraphicsPipelineStateObjectBuilds.CPPOutput)"
            CPPHeaderOutput             ="%(GraphicsPipelineStateObjectBuilds.CPPHeaderOutput)"
            TrackerLogDirectory         ="$(TrackerLogDirectory)"
            ToolPath                    ="$(UCToolsGraphicsPipelineTool1Path)"
            ToolNameExtended            ="$(UCToolsGraphicsPipelineTool1Name)"
             >
            <Output TaskParameter="CPPOutput"            ItemName="ClCompile" />
            <Output TaskParameter="CPPHeaderOutput"      ItemName="ClInclude" />
        </GraphicsPipelineStateObject>
    </Target>


    <Target Name="UcToolsGenerateCompute" DependsOnTargets="UcToolsMakeDirsCompute;UcToolsGenerateComputeItems" Condition="'@(ComputePipelineStateObject)' != ''">
        <ComputePipelineStateObject 
            Source                      ="%(ComputePipelineStateObjectBuilds.FullPath)" EntryPointName ="%(ComputePipelineStateObjectBuilds.EntryPointName)"
            CPPOutput                   ="%(ComputePipelineStateObjectBuilds.CPPOutput)"
            CPPHeaderOutput             ="%(ComputePipelineStateObjectBuilds.CPPHeaderOutput)"
            TrackerLogDirectory         ="$(TrackerLogDirectory)"
            ToolPath                    ="$(UCToolsGraphicsPipelineTool1Path)"
            ToolNameExtended            ="$(UCToolsGraphicsPipelineTool1Name)"
             >
            <Output TaskParameter="CPPOutput"            ItemName="ClCompile" />
            <Output TaskParameter="CPPHeaderOutput"      ItemName="ClInclude" />
        </ComputePipelineStateObject>
    </Target>    

    <Target Name="UcToolsGeneratePixelShader" DependsOnTargets="UcToolsMakeDirsPixelShader;UcToolsGeneratePixelShaderItems" Condition="'@(PixelShader)' != ''">
        <FXCompilerPixel
            Source                      ="%(PixelShaderBuilds.FullPath)" EntryPointName ="%(PixelShaderBuilds.EntryPointName)"
            CPPOutput                   ="%(PixelShaderBuilds.CPPOutput)"
            CPPHeaderOutput             ="%(PixelShaderBuilds.CPPHeaderOutput)"
            TypeName					="%(PixelShaderBuilds.TypeName)"
            TrackerLogDirectory         ="$(TrackerLogDirectory)"
            ToolPath                    ="$(UCToolsGraphicsPipelineShaderCompilerPath)"
            ToolNameExtended            ="$(UCToolsGraphicsPipelineShaderCompilerName)"
            >
            <Output TaskParameter="CPPOutput"            ItemName="ClCompile" />
            <Output TaskParameter="CPPHeaderOutput"      ItemName="ClInclude" />
        </FXCompilerPixel>
    </Target>    
    
    <PropertyGroup>
        <PrepareForBuildDependsOn>
            UcToolsMakeDirsGraphics;
            UcToolsMakeDirsCompute;
            UcToolsMakeDirsPixelShader;
            $(PrepareForBuildBuildDependsOn)
        </PrepareForBuildDependsOn>

        <BeforeClCompileTargets>
            UcToolsGenerateGraphics;
            UcToolsGenerateCompute;
            UcToolsGeneratePixelShader;
            $(BeforeClCompileTargets)
        </BeforeClCompileTargets>
    </PropertyGroup>

</Project>