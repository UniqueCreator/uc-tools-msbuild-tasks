<?xml version="1.0" encoding="utf-8"?>

<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

   <UsingTask AssemblyFile="$(UCToolsBuildTasks)" TaskName="UniqueCreator.Build.Tasks.GraphicsPipelineStateObject"/>

    <PropertyGroup>
        <AutoGeneratedGraphicsPipelineStateObjects Condition="$(AutoGeneratedGraphicsPipelineStateObjects) == ''">$(MSBuildThisFileDirectory)autogen\$(Platform)\$(ProjectName)shaders\</AutoGeneratedGraphicsPipelineStateObjects>
        <AutoGeneratedComputePipelineStateObjects Condition="$(AutoGeneratedGraphicsPipelineStateObjects) == ''">$(MSBuildThisFileDirectory)autogen\$(Platform)\$(ProjectName)shaders\</AutoGeneratedComputePipelineStateObjects>
    </PropertyGroup>

    <ItemDefinitionGroup>
        <GraphicsPipelineStateObject>
            <EntryPointName>main</EntryPointName>
        </GraphicsPipelineStateObject>
    </ItemDefinitionGroup>

    <ItemDefinitionGroup>
        <ComputePipelineStateObject>
            <EntryPointName>main</EntryPointName>
        </ComputePipelineStateObject>
    </ItemDefinitionGroup>

    <Target Name="UcToolsGenerateGraphicsItems" Condition="'@(GraphicsPipelineStateObject)' != ''">
        <CreateItem Include = "@(GraphicsPipelineStateObject)" PreserveExistingMetadata="True" AdditionalMetadata="CPPHeaderOutput=$(AutoGeneratedGraphicsPipelineStateObjects)%(GraphicsPipelineStateObject.EntryPointName).h;CPPOutput=$(AutoGeneratedGraphicsPipelineStateObjects)%(GraphicsPipelineStateObject.EntryPointName).cpp">
            <Output TaskParameter ="Include" ItemName = "GraphicsPipelineStateObjectBuilds"/>
        </CreateItem>
    </Target>   

     <Target Name="UcToolsGenerateComputeItems" Condition="'@(ComputePipelineStateObject)' != ''">
        <CreateItem Include = "@(ComputePipelineStateObject)" PreserveExistingMetadata="True" AdditionalMetadata="CPPHeaderOutput=$(AutoGeneratedComputePipelineStateObjects)%(ComputePipelineStateObject.EntryPointName).h;CPPOutput=$(AutoGeneratedComputePipelineStateObjects)%(ComputePipelineStateObject.EntryPointName).cpp">
            <Output TaskParameter ="Include" ItemName = "ComputePipelineStateObjectBuilds"/>
        </CreateItem>
    </Target>       

    <Target Name="UcToolsMakeDirsGraphics" DependsOnTargets="UcToolsGenerateGraphicsItems" Condition="'@(GraphicsPipelineStateObject)' != ''">

        <ItemGroup Condition="'@(GraphicsPipelineStateObject)'!=''">
          <Outputs Include="@(GraphicsPipelineStateObjectBuilds->Metadata('CPPHeaderOutput')->Distinct())" />
          <Outputs Include="@(GraphicsPipelineStateObjectBuilds->Metadata('CPPOutput')->Distinct())" />
          <DirsToMake Include="@(Outputs->DirectoryName())" />
        </ItemGroup>

        <MakeDir Directories="@(DirsToMake)" />

        <ItemGroup>
            <DirsToMake Remove="@(DirsToMake)" />
        </ItemGroup>
    </Target>

     <Target Name="UcToolsMakeDirsCompute" DependsOnTargets="UcToolsGenerateComputeItems" Condition="'@(ComputePipelineStateObject)' != ''">

        <ItemGroup Condition="'@(ComputePipelineStateObject)'!=''">
          <Outputs Include="@(ComputePipelineStateObjectBuilds->Metadata('CPPHeaderOutput')->Distinct())" />
          <Outputs Include="@(ComputePipelineStateObjectBuilds->Metadata('CPPOutput')->Distinct())" />
          <DirsToMake Include="@(Outputs->DirectoryName())" />
        </ItemGroup>

        <MakeDir Directories="@(DirsToMake)" />

        <ItemGroup>
            <DirsToMake Remove="@(DirsToMake)" />
        </ItemGroup>
    </Target>

    <Target Name="UcToolsGenerateGraphics" DependsOnTargets="UcToolsMakeDirsGraphics;UcToolsGenerateGraphicsItems" Condition="'@(GraphicsPipelineStateObject)' != ''">
        <GraphicsPipelineStateObject 
            Source                      ="%(GraphicsPipelineStateObjectBuilds.FullPath)" EntryPointName ="%(GraphicsPipelineStateObjectBuilds.EntryPointName)"
            CPPOutput                   ="%(GraphicsPipelineStateObjectBuilds.CPPOutput)"
            CPPHeaderOutput             ="%(GraphicsPipelineStateObjectBuilds.CPPHeaderOutput)"
            TrackerLogDirectory         ="$(TrackerLogDirectory)"
            ToolPath                    ="$(UCToolsGraphicsPipelineTool1Path)"
            ToolNameExtended            ="$(UCToolsGraphicsPipelineTool1Name)"
             >
            <Output TaskParameter="CPPOutput"            ItemName="ClCompile" />
            <Output TaskParameter="CPPHeaderOutput"      ItemName="ClInclude" />
        </GraphicsPipelineStateObject>
    </Target>


    <Target Name="UcToolsGenerateCompute" DependsOnTargets="UcToolsMakeDirsCompute;UcToolsGenerateComputeItems" Condition="'@(ComputePipelineStateObject)' != ''">
        <ComputePipelineStateObject 
            Source                      ="%(ComputePipelineStateObjectBuilds.FullPath)" EntryPointName ="%(ComputePipelineStateObjectBuilds.EntryPointName)"
            CPPOutput                   ="%(ComputePipelineStateObjectBuilds.CPPOutput)"
            CPPHeaderOutput             ="%(ComputePipelineStateObjectBuilds.CPPHeaderOutput)"
            TrackerLogDirectory         ="$(TrackerLogDirectory)"
            ToolPath                    ="$(UCToolsComputePipelineTool1Path)"
            ToolNameExtended            ="$(UCToolsComputePipelineTool1Name)"
             >
            <Output TaskParameter="CPPOutput"            ItemName="ClCompile" />
            <Output TaskParameter="CPPHeaderOutput"      ItemName="ClInclude" />
        </ComputePipelineStateObject>
    </Target>    
    
    <PropertyGroup>
        <PrepareForBuildDependsOn>
            UcToolsMakeDirsGraphics;
            UcToolsMakeDirsCompute;
            $(PrepareForBuildBuildDependsOn)
        </PrepareForBuildDependsOn>

        <BeforeClCompileTargets>
            UcToolsGenerateGraphics;
            UcToolsGenerateCompute;
            $(BeforeClCompileTargets)
        </BeforeClCompileTargets>
    </PropertyGroup>

</Project>